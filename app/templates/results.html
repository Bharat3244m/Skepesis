{% extends "base.html" %}

{% block title %}Analysis - Skepesis{% endblock %}

{% block content %}
<div class="results-page cognitive-report">
    <!-- Report Header -->
    <header class="report-header">
        <span class="status-pill success">
            <span class="status-dot"></span>
            Complete
        </span>
        <h1 class="report-title">Cognitive Analysis</h1>
    </header>

    <!-- Metrics Strip -->
    <div class="metrics-strip">
        <div class="metric featured">
            <span class="metric-value" id="accuracy">0%</span>
            <span class="metric-label">Accuracy</span>
        </div>
        <div class="metric">
            <span class="metric-value" id="avgConfidence">0%</span>
            <span class="metric-label">Confidence</span>
        </div>
        <div class="metric">
            <span class="metric-value" id="calibrationScore">0%</span>
            <span class="metric-label">Calibration</span>
        </div>
        <div class="metric">
            <span class="metric-value" id="avgTime">0s</span>
            <span class="metric-label">Avg Time</span>
        </div>
    </div>

    <!-- Cognitive Analysis (Primary Section) -->
    <section class="report-section primary">
        <div class="section-label">Analysis</div>
        
        <div class="cognitive-report-panel" id="aiInsightsContainer">
            <div class="report-block" id="aiPatternCard">
                <div class="report-block-header">
                    <span class="report-block-label">Response Patterns</span>
                </div>
                <div class="report-block-content" id="aiPatternContent">
                    <div class="report-loading">
                        <span class="report-loading-text">Analyzing</span>
                    </div>
                </div>
            </div>
            
            <div class="report-block" id="aiCalibrationCard">
                <div class="report-block-header">
                    <span class="report-block-label">Calibration Status</span>
                </div>
                <div class="report-block-content" id="aiCalibrationContent">
                    <div class="report-loading">
                        <span class="report-loading-text">Assessing</span>
                    </div>
                </div>
            </div>
            
            <div class="report-block" id="aiSummaryCard">
                <div class="report-block-header">
                    <span class="report-block-label">Summary</span>
                </div>
                <div class="report-block-content" id="aiSummaryContent">
                    <div class="report-loading">
                        <span class="report-loading-text">Generating</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Confidence vs Correctness -->
    <section class="report-section">
        <div class="section-label">Confidence Analysis</div>
        
        <div class="confidence-matrix" id="confidenceMatrix">
            <div class="matrix-row">
                <div class="matrix-cell header"></div>
                <div class="matrix-cell header">Correct</div>
                <div class="matrix-cell header">Incorrect</div>
            </div>
            <div class="matrix-row">
                <div class="matrix-cell header">High Confidence</div>
                <div class="matrix-cell calibrated" id="highCorrect">â€”</div>
                <div class="matrix-cell overconfident" id="highIncorrect">â€”</div>
            </div>
            <div class="matrix-row">
                <div class="matrix-cell header">Low Confidence</div>
                <div class="matrix-cell underconfident" id="lowCorrect">â€”</div>
                <div class="matrix-cell calibrated" id="lowIncorrect">â€”</div>
            </div>
        </div>
        
        <div class="confidence-insight" id="confidenceInsight">
            <span class="insight-text">Calculating confidence alignment...</span>
        </div>
    </section>

    <!-- Actions -->
    <footer class="report-actions">
        <a href="/quiz" class="btn-secondary">New Session</a>
        <a href="/dashboard" class="btn-primary">View History</a>
    </footer>
</div>

<script>
const attemptId = {{ attempt_id }};

async function loadResults() {
    try {
        // Load attempt data
        const attemptResponse = await fetch(`/api/attempts/${attemptId}`);
        const attempt = await attemptResponse.json();
        
        // Load insights
        const insightsResponse = await fetch(`/api/attempts/${attemptId}/insights`);
        const data = await insightsResponse.json();
        const insights = data.insights;
        
        // Update metrics
        updateMetrics(insights);
        
        // Update confidence matrix
        updateConfidenceMatrix(insights);
        
        // Load AI-powered insights (Ollama)
        loadAIInsights(insights);
        
    } catch (error) {
        console.error('Error loading results:', error);
        showError();
    }
}

function updateMetrics(insights) {
    const accuracy = Math.round(insights.accuracy);
    const confidence = Math.round(insights.avg_confidence);
    const calibration = Math.round(insights.calibration_score || 0);
    const timeStats = insights.time_stats || {};
    const avgTime = (timeStats.avg_time_per_question || 0).toFixed(1);
    
    document.getElementById('accuracy').textContent = accuracy + '%';
    document.getElementById('avgConfidence').textContent = confidence + '%';
    document.getElementById('calibrationScore').textContent = calibration + '%';
    document.getElementById('avgTime').textContent = avgTime + 's';
}

function updateConfidenceMatrix(insights) {
    const gaps = insights.gaps || {};
    const perf = insights.confidence_performance || {};
    
    // Calculate matrix values
    const highCorrect = perf.high_conf_correct || 0;
    const highIncorrect = (perf.high_conf_questions || 0) - highCorrect;
    const lowCorrect = gaps.underconfident_successes?.length || 0;
    const lowIncorrect = (perf.low_conf_questions || 0) - (perf.low_conf_correct || 0);
    
    // Update matrix cells
    document.getElementById('highCorrect').textContent = highCorrect || 'â€”';
    document.getElementById('highIncorrect').textContent = highIncorrect || 'â€”';
    document.getElementById('lowCorrect').textContent = lowCorrect || 'â€”';
    document.getElementById('lowIncorrect').textContent = lowIncorrect || 'â€”';
    
    // Generate insight text
    const overconfident = gaps.overconfident_errors?.length || 0;
    const underconfident = gaps.underconfident_successes?.length || 0;
    
    let insightText = '';
    if (overconfident > 0 && underconfident > 0) {
        insightText = `Mixed calibration: ${overconfident} overconfident error${overconfident > 1 ? 's' : ''}, ${underconfident} underconfident success${underconfident > 1 ? 'es' : ''}.`;
    } else if (overconfident > 0) {
        insightText = `Overconfidence detected: ${overconfident} high-confidence error${overconfident > 1 ? 's' : ''}. Consider slowing down on questions you feel certain about.`;
    } else if (underconfident > 0) {
        insightText = `Hidden knowledge: ${underconfident} correct answer${underconfident > 1 ? 's' : ''} despite low confidence. Trust your instincts more.`;
    } else {
        insightText = 'Well-calibrated: Your confidence aligns with your actual knowledge.';
    }
    
    document.getElementById('confidenceInsight').innerHTML = `<span class="insight-text">${insightText}</span>`;
}

function showError() {
    document.querySelector('.results-page').innerHTML = `
        <div class="error-state">
            <div class="error-icon">ðŸ”„</div>
            <h2 class="error-title">Can't Show Your Results Yet</h2>
            <p class="error-description">
                Your quiz responses are saved, but we're having trouble
                generating your insights right now.
            </p>
            <div class="error-actions">
                <button onclick="location.reload()" class="btn-primary">Refresh Page</button>
                <a href="/dashboard" class="btn-secondary">View Dashboard</a>
            </div>
        </div>
    `;
}

// Load results on page load
loadResults();

// ============================================================================
// AI INSIGHTS (Ollama Integration)
// ============================================================================

async function loadAIInsights(insights) {
    // Check if AI service is available
    try {
        const statusResponse = await fetch('/api/insights/status');
        const status = await statusResponse.json();
        
        if (!status.ready) {
            showAIUnavailable();
            return;
        }
    } catch (error) {
        showAIUnavailable();
        return;
    }
    
    // Build data summary for AI analysis
    const dataSummary = buildDataSummary(insights);
    
    // Load all AI insights in parallel
    await Promise.all([
        loadPatternInsight(dataSummary),
        loadCalibrationInsight(dataSummary),
        loadSummaryInsight(dataSummary)
    ]);
}

function buildDataSummary(insights) {
    const accuracy = Math.round(insights.accuracy || 0);
    const correct = insights.correct_responses || 0;
    const total = insights.total_responses || 0;
    const avgConf = Math.round(insights.avg_confidence || 0);
    const calibration = Math.round(insights.calibration_score || 0);
    const timeStats = insights.time_stats || {};
    const avgTime = (timeStats.avg_time_per_question || 0).toFixed(1);
    const confPerf = insights.confidence_performance || {};
    const gaps = insights.gaps || {};
    const overconfident = (gaps.overconfident_errors || []).length;
    const underconfident = (gaps.underconfident_successes || []).length;
    const style = insights.learning_style || 'unknown';
    
    return {
        full: `Score: ${correct}/${total} (${accuracy}%). Avg confidence: ${avgConf}%. Calibration: ${calibration}%. Avg time: ${avgTime}s. Learning style: ${style}. High-confidence accuracy: ${Math.round(confPerf.high_confidence_accuracy || 0)}%. Overconfident errors: ${overconfident}. Underconfident successes: ${underconfident}.`,
        pattern: `${total} questions answered. Accuracy: ${accuracy}%. Avg response time: ${avgTime}s. Time on correct: ${(timeStats.avg_time_correct || 0).toFixed(1)}s. Time on incorrect: ${(timeStats.avg_time_incorrect || 0).toFixed(1)}s. Learning style detected: ${style}.`,
        calibration: `${total} questions. Confidence avg: ${avgConf}%. Accuracy: ${accuracy}%. High-confidence questions: ${confPerf.high_conf_questions || 0} with ${Math.round(confPerf.high_confidence_accuracy || 0)}% accuracy. Overconfident errors: ${overconfident}. Underconfident correct: ${underconfident}.`
    };
}

async function loadPatternInsight(dataSummary) {
    const container = document.getElementById('aiPatternContent');
    try {
        const response = await fetch('/api/insights/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: dataSummary.pattern,
                type: 'pattern'
            })
        });
        
        if (!response.ok) throw new Error('API error');
        
        const result = await response.json();
        container.innerHTML = formatReportContent(result.insight);
        container.parentElement.classList.add('loaded');
    } catch (error) {
        console.error('Pattern insight error:', error);
        container.innerHTML = '<p class="report-error">Unable to generate analysis</p>';
    }
}

async function loadCalibrationInsight(dataSummary) {
    const container = document.getElementById('aiCalibrationContent');
    try {
        const response = await fetch('/api/insights/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: dataSummary.calibration,
                type: 'calibration'
            })
        });
        
        if (!response.ok) throw new Error('API error');
        
        const result = await response.json();
        container.innerHTML = formatReportContent(result.insight);
        container.parentElement.classList.add('loaded');
    } catch (error) {
        console.error('Calibration insight error:', error);
        container.innerHTML = '<p class="report-error">Unable to generate assessment</p>';
    }
}

async function loadSummaryInsight(dataSummary) {
    const container = document.getElementById('aiSummaryContent');
    try {
        const response = await fetch('/api/insights/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: dataSummary.full,
                type: 'summary'
            })
        });
        
        if (!response.ok) throw new Error('API error');
        
        const result = await response.json();
        container.innerHTML = formatReportContent(result.insight);
        container.parentElement.classList.add('loaded');
    } catch (error) {
        console.error('Summary insight error:', error);
        container.innerHTML = '<p class="report-error">Unable to generate summary</p>';
    }
}

function formatReportContent(text) {
    if (!text) return '<p class="report-text">No data available.</p>';
    
    // Parse the text into structured sections
    let html = '<div class="report-content">';
    
    // Split by line breaks and process
    const lines = text.split('\n').filter(line => line.trim());
    
    lines.forEach(line => {
        const trimmed = line.trim();
        
        // Detect status labels (e.g., "Calibration Status: Overconfident")
        if (trimmed.includes(':') && trimmed.split(':')[0].length < 30) {
            const [label, ...valueParts] = trimmed.split(':');
            const value = valueParts.join(':').trim();
            
            // Check if value contains status keywords
            const statusClass = getStatusClass(value);
            
            if (statusClass) {
                html += `<div class="report-finding">
                    <span class="report-finding-label">${label.trim()}</span>
                    <span class="report-status ${statusClass}">${value}</span>
                </div>`;
            } else if (label.trim().length > 0 && value.length > 0) {
                html += `<div class="report-finding">
                    <span class="report-finding-label">${label.trim()}</span>
                    <span class="report-finding-value">${value}</span>
                </div>`;
            } else {
                html += `<p class="report-text">${trimmed}</p>`;
            }
        }
        // Detect bullet points
        else if (trimmed.startsWith('â€¢') || trimmed.startsWith('-') || trimmed.startsWith('*')) {
            const bulletText = trimmed.replace(/^[â€¢\-\*]\s*/, '');
            html += `<div class="report-bullet">${bulletText}</div>`;
        }
        // Detect numbered items
        else if (/^\d+[\.\)]\s/.test(trimmed)) {
            const itemText = trimmed.replace(/^\d+[\.\)]\s*/, '');
            html += `<div class="report-bullet">${itemText}</div>`;
        }
        // Regular paragraph
        else {
            html += `<p class="report-text">${trimmed}</p>`;
        }
    });
    
    html += '</div>';
    return html;
}

function getStatusClass(text) {
    const lower = text.toLowerCase();
    if (lower.includes('overconfident') || lower.includes('over-confident')) return 'status-warning';
    if (lower.includes('underconfident') || lower.includes('under-confident')) return 'status-info';
    if (lower.includes('well-calibrated') || lower.includes('well calibrated') || lower.includes('calibrated')) return 'status-success';
    if (lower.includes('quick') || lower.includes('fast')) return 'status-neutral';
    if (lower.includes('deliberate') || lower.includes('slow')) return 'status-neutral';
    if (lower.includes('moderate') || lower.includes('balanced')) return 'status-success';
    return null;
}

function showAIUnavailable() {
    const container = document.getElementById('aiInsightsContainer');
    container.innerHTML = `
        <div class="report-unavailable">
            <p class="report-unavailable-text">Cognitive analysis is currently unavailable</p>
            <p class="report-unavailable-subtext">The analysis service could not be reached</p>
        </div>
    `;
}
</script>
{% endblock %}
