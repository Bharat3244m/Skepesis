{% extends "base.html" %}

{% block title %}Attempt Details - Skepesis{% endblock %}

{% block content %}
<div class="attempt-details-page">
    <!-- Header -->
    <div class="details-header">
        <div class="breadcrumb">
            <a href="/">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/dashboard">Progress</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">Attempt Details</span>
        </div>
        <h1 class="details-title" id="attemptTitle">Loading...</h1>
        <div class="details-meta" id="attemptMeta"></div>
    </div>

    <!-- Summary Stats -->
    <div class="summary-stats" id="summaryStats">
        <div class="loader"></div>
    </div>

    <!-- Question Breakdown -->
    <div class="breakdown-section">
        <div class="section-header">
            <h2 class="section-title">Question-by-Question Breakdown</h2>
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all" onclick="filterQuestions('all')">
                    All <span class="tab-count" id="countAll">0</span>
                </button>
                <button class="filter-tab" data-filter="correct" onclick="filterQuestions('correct')">
                    ‚úì Correct <span class="tab-count" id="countCorrect">0</span>
                </button>
                <button class="filter-tab" data-filter="incorrect" onclick="filterQuestions('incorrect')">
                    ‚úó Incorrect <span class="tab-count" id="countIncorrect">0</span>
                </button>
                <button class="filter-tab" data-filter="high-confidence" onclick="filterQuestions('high-confidence')">
                    üí™ High Confidence <span class="tab-count" id="countHighConf">0</span>
                </button>
                <button class="filter-tab" data-filter="low-confidence" onclick="filterQuestions('low-confidence')">
                    üò∞ Low Confidence <span class="tab-count" id="countLowConf">0</span>
                </button>
            </div>
        </div>
        
        <div class="questions-list" id="questionsList">
            <div class="loader"></div>
        </div>
    </div>

    <!-- Actions -->
    <div class="details-actions">
        <a href="/dashboard" class="btn-secondary">Back to Dashboard</a>
        <a href="/results/{{ attempt_id }}" class="btn-primary" id="insightsLink">View Insights</a>
    </div>
</div>

<script>
const attemptId = "{{ attempt_id }}";
let allResponses = [];
let currentFilter = 'all';

async function loadAttemptDetails() {
    try {
        const response = await fetch(`/api/attempts/${attemptId}/responses`);
        const data = await response.json();
        
        allResponses = data.responses;
        
        // Update header
        document.getElementById('attemptTitle').textContent = `${data.student_name}'s Session`;
        
        const startDate = new Date(data.started_at);
        const dateStr = startDate.toLocaleDateString('en-US', { 
            month: 'long', 
            day: 'numeric', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const status = data.completed_at ? 'Completed' : 'In Progress';
        document.getElementById('attemptMeta').innerHTML = `
            <span class="meta-item">üìÖ ${dateStr}</span>
            <span class="badge ${data.completed_at ? 'success' : 'info'}">${status}</span>
        `;
        
        // Update summary stats
        updateSummaryStats(data);
        
        // Update filter counts
        updateFilterCounts(allResponses);
        
        // Display questions
        displayQuestions(allResponses);
        
    } catch (error) {
        console.error('Error loading attempt details:', error);
        showError();
    }
}

function updateSummaryStats(data) {
    const accuracy = data.total_questions > 0 
        ? Math.round((data.correct_answers / data.total_questions) * 100)
        : 0;
    
    const html = `
        <div class="summary-card">
            <div class="summary-icon">‚úì</div>
            <div class="summary-content">
                <div class="summary-value">${data.correct_answers}/${data.total_questions}</div>
                <div class="summary-label">Correct Answers</div>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">üéØ</div>
            <div class="summary-content">
                <div class="summary-value">${accuracy}%</div>
                <div class="summary-label">Accuracy</div>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">üîç</div>
            <div class="summary-content">
                <div class="summary-value">${Math.round(data.curiosity_score)}</div>
                <div class="summary-label">Curiosity Score</div>
            </div>
        </div>
        
        <div class="summary-card">
            <div class="summary-icon">üí≠</div>
            <div class="summary-content">
                <div class="summary-value">${Math.round(data.average_confidence)}%</div>
                <div class="summary-label">Avg Confidence</div>
            </div>
        </div>
    `;
    
    document.getElementById('summaryStats').innerHTML = html;
}

function updateFilterCounts(responses) {
    const correct = responses.filter(r => r.is_correct).length;
    const incorrect = responses.filter(r => !r.is_correct).length;
    const highConf = responses.filter(r => r.confidence >= 75).length;
    const lowConf = responses.filter(r => r.confidence < 50).length;
    
    document.getElementById('countAll').textContent = responses.length;
    document.getElementById('countCorrect').textContent = correct;
    document.getElementById('countIncorrect').textContent = incorrect;
    document.getElementById('countHighConf').textContent = highConf;
    document.getElementById('countLowConf').textContent = lowConf;
}

function filterQuestions(filter) {
    currentFilter = filter;
    
    // Update active tab
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === filter) {
            tab.classList.add('active');
        }
    });
    
    // Filter and display
    let filtered = allResponses;
    
    switch(filter) {
        case 'correct':
            filtered = allResponses.filter(r => r.is_correct);
            break;
        case 'incorrect':
            filtered = allResponses.filter(r => !r.is_correct);
            break;
        case 'high-confidence':
            filtered = allResponses.filter(r => r.confidence >= 75);
            break;
        case 'low-confidence':
            filtered = allResponses.filter(r => r.confidence < 50);
            break;
    }
    
    displayQuestions(filtered);
}

function displayQuestions(responses) {
    const container = document.getElementById('questionsList');
    
    if (responses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <h3 class="empty-state-title">No Questions Match</h3>
                <p class="empty-state-description">
                    Try selecting a different filter to explore your responses.
                </p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    responses.forEach((response, index) => {
        const confidenceLevel = response.confidence >= 75 ? 'high' : 
                               response.confidence >= 50 ? 'medium' : 'low';
        const confidenceEmoji = response.confidence >= 75 ? 'üòé' : 
                               response.confidence >= 50 ? 'üòê' : 'üò∞';
        
        const curiosityIndicator = getCuriosityIndicator(response);
        
        html += `
            <div class="question-item ${response.is_correct ? 'correct' : 'incorrect'}">
                <div class="question-item-header">
                    <div class="question-number">Question ${index + 1}</div>
                    <div class="question-badges">
                        <span class="category-badge">${response.category}</span>
                        <span class="difficulty-badge">${response.difficulty}</span>
                        <span class="result-badge ${response.is_correct ? 'correct' : 'incorrect'}">
                            ${response.is_correct ? '‚úì Correct' : '‚úó Incorrect'}
                        </span>
                    </div>
                </div>
                
                <div class="question-text">${response.question_text}</div>
                
                <div class="question-answers">
                    <div class="answer-item ${response.is_correct ? 'user-correct' : 'user-incorrect'}">
                        <span class="answer-label">Your Answer:</span>
                        <span class="answer-value">${response.user_answer}</span>
                    </div>
                    ${!response.is_correct ? `
                        <div class="answer-item correct-answer">
                            <span class="answer-label">Correct Answer:</span>
                            <span class="answer-value">${response.correct_answer}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="question-meta">
                    <div class="meta-item">
                        <span class="meta-label">Confidence:</span>
                        <div class="confidence-display">
                            <span class="confidence-emoji">${confidenceEmoji}</span>
                            <div class="confidence-bar-small">
                                <div class="confidence-bar-fill ${confidenceLevel}" style="width: ${response.confidence}%"></div>
                            </div>
                            <span class="confidence-value">${response.confidence}%</span>
                        </div>
                    </div>
                    
                    <div class="meta-item">
                        <span class="meta-label">Time Taken:</span>
                        <span class="meta-value">${response.time_taken}s</span>
                    </div>
                    
                    <div class="meta-item">
                        <span class="meta-label">Pattern:</span>
                        <span class="meta-value">${curiosityIndicator}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function getCuriosityIndicator(response) {
    const conf = response.confidence;
    const correct = response.is_correct;
    
    if (correct && conf >= 75) return 'üí™ Confident & Correct';
    if (correct && conf < 50) return '‚ú® Lucky or Underconfident';
    if (!correct && conf >= 75) return '‚ö†Ô∏è Overconfident';
    if (!correct && conf < 50) return 'üé≤ Guessing';
    return 'üéØ Calibrated';
}

function showError() {
    document.querySelector('.attempt-details-page').innerHTML = `
        <div class="error-state">
            <div class="error-icon">üìã</div>
            <h2 class="error-title">Can't Load Session Details</h2>
            <p class="error-description">
                This session might not exist, or there might be a temporary connection issue.
                Your data is safe ‚Äî let's try another option.
            </p>
            <div class="error-actions">
                <a href="/dashboard" class="btn-primary">Back to Dashboard</a>
                <button onclick="location.reload()" class="btn-secondary">Refresh Page</button>
            </div>
        </div>
    `;
}

// Load details on page load
loadAttemptDetails();
</script>
{% endblock %}
