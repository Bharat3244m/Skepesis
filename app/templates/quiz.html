{% extends "base.html" %}

{% block title %}Quiz ‚Äî Skepesis{% endblock %}

{% block content %}
<div class="quiz-container">
    <!-- Progress Bar -->
    <div class="quiz-progress">
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div class="progress-info">
            <span id="questionCounter">Question 1 of 10</span>
            <span id="timer">00:00</span>
        </div>
    </div>
    
    <!-- Question Block -->
    <div class="question-block" id="questionPanel">
        <div class="question-header">
            <span class="question-category" id="questionCategory">Loading...</span>
        </div>
        
        <div class="question-content">
            <h2 class="question-text" id="questionText">Loading question...</h2>
        </div>
        
        <!-- Answer Options -->
        <div class="answer-section">
            <div class="answer-label">Select your answer:</div>
            <div class="options-list" id="optionsGrid">
                <!-- Options will be inserted here -->
            </div>
        </div>
        
        <!-- Confidence Rating -->
        <div class="confidence-section" id="confidenceSection">
            <div class="confidence-header">
                <span class="confidence-label">Confidence</span>
                <span class="confidence-value-display" id="confidenceDisplay">
                    <span id="confidenceText">Moderate</span>
                </span>
            </div>
            <div class="confidence-track">
                <input 
                    type="range" 
                    id="confidenceSlider" 
                    class="confidence-slider"
                    min="1" 
                    max="5" 
                    value="3"
                    step="1"
                >
                <div class="confidence-labels">
                    <span>Low</span>
                    <span></span>
                    <span>Medium</span>
                    <span></span>
                    <span>High</span>
                </div>
            </div>
        </div>
        
        <!-- Submit Button -->
        <div class="quiz-actions">
            <button class="btn-primary btn-large btn-submit" id="submitBtn" onclick="submitAnswer()" disabled>
                Next Question
            </button>
        </div>
    </div>
    
    <!-- Completion Screen -->
    <div class="completion-screen hidden" id="completionPanel">
        <div class="completion-content">
            <div class="completion-icon">‚úì</div>
            <h2 class="completion-title">Session Complete</h2>
            <p class="completion-text">Analyzing your responses and generating personalized insights...</p>
            <div class="loader"></div>
        </div>
    </div>
</div>

<script>
let attemptId = null;
let questions = [];
let currentQuestionIndex = 0;
let startTime = Date.now();
let questionStartTime = Date.now();
let selectedAnswer = null;

// Parse URL parameters
const urlParams = new URLSearchParams(window.location.search);
attemptId = urlParams.get('attempt_id');
const questionCount = urlParams.get('count') || 10;
const category = urlParams.get('category') || '';

if (!attemptId) {
    window.location.href = '/';
}

// Load questions
async function loadQuestions() {
    try {
        const url = `/api/questions/random?limit=${questionCount}${category ? '&category=' + category : ''}`;
        const response = await fetch(url);
        questions = await response.json();
        
        if (questions.length === 0) {
            document.getElementById('questionPanel').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ü§î</div>
                    <h3 class="empty-state-title">No Questions Available</h3>
                    <p class="empty-state-description">
                        We don't have questions for this category right now.
                        Try selecting a different category or starting a general quiz.
                    </p>
                    <div class="error-actions">
                        <a href="/" class="btn-primary">Choose Different Category</a>
                    </div>
                </div>
            `;
            return;
        }
        
        displayQuestion();
        startTimer();
    } catch (error) {
        console.error('Error loading questions:', error);
        document.getElementById('questionPanel').innerHTML = `
            <div class="error-state">
                <div class="error-icon">üìö</div>
                <h2 class="error-title">Can't Load Questions</h2>
                <p class="error-description">
                    We're having trouble getting your questions ready.
                    This usually means a quick connection hiccup.
                </p>
                <div class="error-actions">
                    <button onclick="location.reload()" class="btn-primary">Try Again</button>
                    <a href="/" class="btn-secondary">Back to Home</a>
                </div>
            </div>
        `;
    }
}

function displayQuestion() {
    const question = questions[currentQuestionIndex];
    questionStartTime = Date.now();
    selectedAnswer = null;
    
    // Update header info
    document.getElementById('questionCategory').textContent = question.category;
    document.getElementById('questionText').textContent = question.text;
    document.getElementById('questionCounter').textContent = 
        `Question ${currentQuestionIndex + 1} of ${questions.length}`;
    
    // Update progress bar
    const progress = ((currentQuestionIndex) / questions.length) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    // Display options
    const optionsGrid = document.getElementById('optionsGrid');
    optionsGrid.innerHTML = '';
    
    const options = [
        { key: 'A', value: question.option_a },
        { key: 'B', value: question.option_b },
        { key: 'C', value: question.option_c },
        { key: 'D', value: question.option_d }
    ].filter(opt => opt.value);
    
    options.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `
            <span class="option-key">${option.key}</span>
            <span class="option-text">${option.value}</span>
        `;
        btn.onclick = () => selectOption(option.key, btn);
        optionsGrid.appendChild(btn);
    });
    
    // Reset confidence slider
    document.getElementById('confidenceSlider').value = 3;
    updateConfidenceDisplay(3);
    
    // Disable submit button until answer is selected
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').textContent = 
        currentQuestionIndex === questions.length - 1 ? 'Complete Quiz' : 'Next Question';
}

function selectOption(key, button) {
    // Remove previous selection
    document.querySelectorAll('.option-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Add selection with animation
    button.classList.add('selected');
    selectedAnswer = key;
    
    // Enable submit button
    document.getElementById('submitBtn').disabled = false;
    
    // Subtle highlight effect
    button.style.animation = 'selectPulse 0.3s ease';
    setTimeout(() => {
        button.style.animation = '';
    }, 300);
}

function updateConfidenceDisplay(value) {
    const labels = ['Low', 'Low-Medium', 'Medium', 'Medium-High', 'High'];
    document.getElementById('confidenceText').textContent = labels[value - 1];
}

async function submitAnswer() {
    if (!selectedAnswer) {
        return;
    }
    
    // Convert 1-5 scale to 0-100 for backend
    const confidence = parseInt(document.getElementById('confidenceSlider').value);
    const confidencePercentage = (confidence - 1) * 25; // 1=0%, 2=25%, 3=50%, 4=75%, 5=100%
    const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
    
    // Disable button to prevent double submission
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    try {
        const question = questions[currentQuestionIndex];
        const response = await fetch('/api/responses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                attempt_id: attemptId,
                question_id: question.id,
                user_answer: selectedAnswer,
                confidence_level: confidencePercentage,
                time_spent: timeSpent,
                correct_answer: question.correct_answer || null,
                // Include question metadata for analysis
                question_text: question.text || null,
                category: question.category || 'General',
                difficulty: question.difficulty || 'medium'
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to submit answer');
        }
        
        // Move to next question or complete
        currentQuestionIndex++;
        
        if (currentQuestionIndex < questions.length) {
            // Fade out current question
            document.getElementById('questionPanel').style.opacity = '0';
            setTimeout(() => {
                displayQuestion();
                document.getElementById('questionPanel').style.opacity = '1';
            }, 200);
        } else {
            await completeQuiz();
        }
    } catch (error) {
        console.error('Error submitting answer:', error);
        
        // Show friendly error message
        const errorMsg = document.createElement('div');
        errorMsg.className = 'inline-error';
        errorMsg.innerHTML = `
            <span class="error-icon">‚ö†Ô∏è</span>
            <span>Couldn't save your answer. Please try submitting again.</span>
        `;
        errorMsg.style.cssText = 'padding: 12px; background: rgba(239, 68, 68, 0.1); color: #DC2626; border-radius: 8px; margin-top: 16px; display: flex; align-items: center; gap: 8px; font-size: 14px;';
        
        const actionsDiv = document.querySelector('.quiz-actions');
        actionsDiv.insertBefore(errorMsg, actionsDiv.firstChild);
        
        // Remove error after 5 seconds
        setTimeout(() => errorMsg.remove(), 5000);
        
        submitBtn.disabled = false;
        submitBtn.textContent = currentQuestionIndex === questions.length - 1 ? 'Complete Quiz' : 'Next Question';
    }
}

async function completeQuiz() {
    document.getElementById('questionPanel').classList.add('hidden');
    document.getElementById('completionPanel').classList.remove('hidden');
    
    try {
        await fetch(`/api/attempts/${attemptId}/complete`, {
            method: 'POST'
        });
        
        // Redirect to results after 2 seconds
        setTimeout(() => {
            window.location.href = `/results/${attemptId}`;
        }, 2000);
    } catch (error) {
        console.error('Error completing quiz:', error);
    }
}

function startTimer() {
    setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('timer').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }, 1000);
}

// Update confidence display on slider change
document.getElementById('confidenceSlider').addEventListener('input', (e) => {
    updateConfidenceDisplay(parseInt(e.target.value));
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    // Number keys 1-4 for options
    if (e.key >= '1' && e.key <= '4') {
        const options = document.querySelectorAll('.option-btn');
        if (options[parseInt(e.key) - 1]) {
            options[parseInt(e.key) - 1].click();
        }
    }
    // Enter to submit
    if (e.key === 'Enter' && !document.getElementById('submitBtn').disabled) {
        submitAnswer();
    }
});

// Initialize
loadQuestions();
</script>
{% endblock %}
